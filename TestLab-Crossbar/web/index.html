<!DOCTYPE html>
<!--
###############################################################################
##
##  Copyright (c) Crossbar.io Technologies GmbH and/or collaborators. All rights reserved.
##
##  Redistribution and use in source and binary forms, with or without
##  modification, are permitted provided that the following conditions are met:
##
##  1. Redistributions of source code must retain the above copyright notice,
##     this list of conditions and the following disclaimer.
##
##  2. Redistributions in binary form must reproduce the above copyright notice,
##     this list of conditions and the following disclaimer in the documentation
##     and/or other materials provided with the distribution.
##
##  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
##  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
##  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
##  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
##  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
##  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
##  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
##  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
##  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
##  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
##  POSSIBILITY OF SUCH DAMAGE.
##
###############################################################################
-->

<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ambulance Case sensor & location information</title>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="./dist/autobahn.min.js"></script>
    <script src="./dist/plotly-latest.min.js"></script>
    <script src="./dist/smoothie.js"></script>
    <script src="./dist/jquery-1.12.4.js"></script>
    <script src="./dist/jquery-ui.js"></script>
    <script src="./dist/moment.min.js"></script>
    <script>
        $(function() {
            $("#accordion").accordion({
                collapsible: true,
                heightStyle: "content",
                activate: function(event, ui) {
                    google.maps.event.trigger(map, 'resize');
                    centerGoogleMaps(thingsee_location);
                }
            });
        });
        $( window ).resize(function() {
            var y = $(window).width() * 0.981;
            console.log("Adjusting ECG width due to window resize. Width: " + y)
            $('#ecg_canvas').attr('width', y); //Adjust ECG curve width

            var update = {
              width: $(window).width() / 3
            };

            Plotly.relayout('energy', update);
            Plotly.relayout('activity', update);
            Plotly.relayout('sleep', update);
            Plotly.relayout('bodytemp', update);
            Plotly.relayout('bloodpressure', update);
            Plotly.relayout('heartrate', update);
        });
    </script>
</head>

<body>
    <div id="textbox">
    <p id="page_headline">Telemetry and Location information</p>
    </div>
    <p id="userid" class="text"></p>
    <div style="clear: both;"></div>
    <hr>
    <!--<div id="accordion"> -->
    <h3 id='headline1'>Sensor Telemetry</h3>
    <div class="sensory_data">
        <table>
            <colgroup>
               <col span="1" style="width: 33vw; position: relative;">
               <col span="1" style="width: 33vw; position: relative;">
               <col span="1" style="width: 33vw; position: relative;">
            </colgroup>
            <tr>
                <td><div id="energy"></div></td>
                <td><div id="activity"></div></td>
                <td><div id="sleep"></div></td>
            </tr>
            <tr>
                <td><div id="bodytemp"></div></td>
                <td><div id="bloodpressure"></div></td>
                <td><div id="heartrate"></div></td>
            </tr>
        </table>
    <h3 id='headline3'>Location</h3>
        <hr>
        <div id="map"></div>
    <h3 id='headline2'>ECG Feed</h3>
        <hr>
        <div><canvas id="ecg_canvas"></canvas></div>
    </div>
    <!--</div>-->
    <script>
        // data structures holding the data
        var ecg_streaming_chart = new SmoothieChart();
        var ecg_line_series = new TimeSeries();

        var user_id = ""

        var energy_data = [];
        var activity_data = [];
        var sleep_data = [];
        var bloodpressure_data = [];
        var bodytemp_data = [];
        var heartrate_data = [];
        var ecg_data = [];

        // the URL of the WAMP Router (Crossbar.io)
        var wsuri;

        // timers used
        var haltianTimer = 0
        var thingsee_location = null

        // Google Maps object
        var map = null

        if (document.location.origin == "file://") {
            wsuri = "ws://localhost:8080/ws";
        } else {
            wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";
        }
        // the WAMP connection to the Router
        var connection = new autobahn.Connection({
            url: wsuri,
            realm: "realm2"
        });

        //Utility functions:
        function init() {
            user_id = getQueryVariable("hetu");
            if (!user_id)
                user_id = "050160-740C"; //Test patient
            $('#page_headline').html("Telemetry and Location information " + user_id);
            user_id = getWithingsID(user_id)
        }

        function getWithingsID(id)
        {
            if(id == "050160-740C")
                return "12762571"
            else
                return "12762926"
        }

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }

        function create_plot(data, target_div) {
            for (name in data) {
                if(name == user_id) {
                    Plotly.newPlot(target_div, data[name][0].data, data[name][0].layout);
                }
            }
        }

        //Utility functions used in formatting various of plots used in the web page
        function format_line_plot(data, title, xaxis_title, yaxis_title) {
            for (name in data) {
                data[name][0].data[0].mode = 'lines+markers'
                data[name][0].data[0].name = 'Date'
                data[name][0].data[0].line = {
                    color: 'darkgrey',
                    width: 3
                }
                data[name][0].layout = {
                    title: title,
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    xaxis: {
                        title: xaxis_title,
                        showgrid: false,
                        zeroline: false
                    },
                    yaxis: {
                        title: yaxis_title,
                        showline: false
                    }
                };
            }

            return data
        }

        function format_bar_plot(data, title, xaxis_title, yaxis_title) {
            for (name in data) {
                data[name][0].data[0].type = 'bar'
                data[name][0].data[0].name = 'Date'
                data[name][0].data[0].marker = {
                    color: 'darkgrey'
                }
                data[name][0].layout = {
                    title: title,
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    xaxis: {
                        title: xaxis_title,
                        showgrid: false,
                        zeroline: false,
                    },
                    yaxis: {
                        title: yaxis_title,
                        showline: false,
                    }
                };
            }

            return data
        }

        function format_tuple_bar_plot(data, title, a_title, b_title, xaxis_title, yaxis_title) {
            for (name in data) {

                data[name][0].data[0] = {
                    x: data[name][0].data[0].x,
                    y: data[name][0].data[0].y,
                    type: 'bar',
                    name: a_title,
                    marker: {
                        color: 'red'
                    }
                }

                data[name][0].data[1] = {
                    x: data[name][0].data[1].x,
                    y: data[name][0].data[1].y,
                    type: 'bar',
                    name: b_title,
                    marker: {
                        color: 'lightgreen',
                        width: 3
                    }
                }

                data[name][0].layout = {
                    title: title,
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    xaxis: {
                        title: xaxis_title,
                        showgrid: false,
                        zeroline: false
                    },
                    yaxis: {
                        title: yaxis_title,
                        showline: false
                    }
                };
            }

            return data
        }

        function layout_bloodpressure() {
            //var now = moment().format("YYYY-MM-DD hh:mm:ss")
            var now = bloodpressure_data
            var delta = moment().subtract(20, 'days').format("YYYY-MM-DD hh:mm:ss")
            var update = {
                xaxis: { range: [delta, now] },
                width: $(window).width() / 3
            };

            Plotly.relayout('bloodpressure', update);
        }

        function layout_bodytemperature() {
            var now = moment().format("YYYY-MM-DD hh:mm:ss")
            var delta = moment().subtract(14, 'days').format("YYYY-MM-DD hh:mm:ss")
            var update = {
                yaxis: { range: [30, 42] },
                xaxis: { range: [delta, now] },
                width: $(window).width() / 3
            };

            Plotly.relayout('bodytemp', update);
        }

        function layout_heartrate() {

            var now = moment().format("YYYY-MM-DD hh:mm:ss")
            var delta = moment().subtract(20, 'days').format("YYYY-MM-DD hh:mm:ss")
            var update = {
                xaxis: { range: [delta, now] },
                width: $(window).width() / 3
            };

            Plotly.relayout('heartrate', update);
        }

        //Handler functions for handling new deltas received from the server
        function handle_energy(data) {
            energy_data = JSON.parse(data)
            energy_data = format_line_plot(energy_data, "Energy Consumption", "Date", "Calories")
            create_plot(energy_data, "energy")
        }

        function handle_activity(data) {
            activity_data = JSON.parse(data)
            activity_data = format_line_plot(activity_data, "Activity Statistics", "Date", "Activity")
            create_plot(activity_data, "activity")
        }

        function handle_sleep(data) {
            sleep_data = JSON.parse(data)
            sleep_data = format_line_plot(sleep_data, "Sleep Duration", "Date", "Hours")
            create_plot(sleep_data, "sleep")
        }

        function handle_bloodpressure(data) {
            bloodpressure_data = JSON.parse(data)
            bloodpressure_data = format_tuple_bar_plot(bloodpressure_data, "Blood Pressure", "Systolic", "Diastolic", "Date", "mmHg")
            create_plot(bloodpressure_data, "bloodpressure")

            //layout_bloodpressure()
        }

        function handle_heartrate(data) {
            heartrate_data = JSON.parse(data)
            heartrate_data = format_bar_plot(heartrate_data, "Average Heartrate", "Date", "BPM")
            create_plot(heartrate_data, "heartrate")

            //layout_heartrate()
        }

        function handle_bodytemp(data) {
            bodytemp_data = JSON.parse(data)
            bodytemp_data = format_line_plot(bodytemp_data, "Body Temperature", "Date", "Celcius")
            create_plot(bodytemp_data, "bodytemp")

            //layout_bodytemperature()
        }

        function initGoogleMaps() {
            console.log("Initializing Google Maps");
            thingsee_location = new google.maps.LatLng(65.0066601, 25.5235996)
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: {
                    lat: thingsee_location.lat(),
                    lng: thingsee_location.lng()
                }
            });

            google.maps.event.trigger(map, 'resize');
        }

        function updateGoogleMaps(data) {
            if(data.length != 0)
            {
                if(typeof(data[0]) == 'undefined')
                    thingsee_location = new google.maps.LatLng(data.lat, data.lon)
                else
                    thingsee_location = new google.maps.LatLng(data[0].lat, data[0].lon)

                marker = new google.maps.Marker({
                    position: thingsee_location,
                    map: map
                });
                centerGoogleMaps(thingsee_location)
            }
        }

        function centerGoogleMaps(location) {
            map.setCenter(location)
        }

        //Utility function to update or add a new value to a existing data set
        function update_axis_data(data, value) {
            index = jQuery.inArray(value[1], data[value[0]][0].data[0].x)
            if(index > -1) {
                if(value[2] instanceof Array) { //this value is related to bloodpressure
                    data[value[0]][0].data[0].y[index] = value[2][0]
                    data[value[0]][0].data[1].y[index] = value[2][1]
                }
                else {
                    console.log("Updating data with: " + value[1] + " : " + value[2])
                    data[value[0]][0].data[0].y[index] = Math.round10(value[2])
                }
            }
            else { //new information
                if(value[2] instanceof Array) { //this value is related to bloodpressure
                    data[value[0]][0].data[0].x.push(value[1]);
                    data[value[0]][0].data[1].x.push(value[1]);
                    data[value[0]][0].data[0].y.push(value[2][0]);
                    data[value[0]][0].data[1].y.push(value[2][1]);
                }
                else {
                    console.log("Adding new data: " + value[1] + " : " + value[2])
                    data[value[0]][0].data[0].x.push(value[1])
                    data[value[0]][0].data[0].y.push(value[2])
                }
            }

            return data
        }

        // fired when connection is established and session attached
        connection.onopen = function(session, details) {

            console.log("Connected");
            ecg_curve_initialized = false

            // GET data about ThingseeOne location
            session.call('com.testlab.haltian_location').then(
                function(res) { //Success
                    console.log("Received data for Haltian location")
                    console.log(res)
                    updateGoogleMaps(JSON.parse(res));
                },
                function(err) { //Failure
                    console.log("Error while calling Haltian Location service: ", err);
                }
            );

            // GET initial data sets from Withings
            session.call('com.testlab.withings_energy', ["plotly"]).then(
                function(res) { //Success
                    console.log("Received data for Energy")
                    handle_energy(res)
                },
                function(err) { //Failure
                    console.log("Error while calling Energy API: ", err);
                }
            );
            session.call('com.testlab.withings_activity', ["plotly"]).then(
                function(res) { //Success
                    console.log("Received data for Activity")
                    handle_activity(res)
                },
                function(err) { //Failure
                    console.log("Error while calling Activity API: ", err);
                }
            );
            session.call('com.testlab.withings_sleep', ["plotly"]).then(
                function(res) { //Success
                    console.log("Received data for Sleep activity")
                    handle_sleep(res)
                },
                function(err) { //Failure
                    console.log("Error while calling Sleep API: ", err);
                }
            );
            session.call('com.testlab.withings_bloodpressure', ["plotly"]).then(
                function(res) { //Success
                    console.log("Received data for Bloodpressure")
                    handle_bloodpressure(res)
                },
                function(err) { //Failure
                    console.log("Error while calling BP API: ", err);
                }
            );
            session.call('com.testlab.withings_bodytemperature', ["plotly"]).then(
                function(res) { //Success
                    console.log("Received data for Bodytemperature")
                    handle_bodytemp(res)
                },
                function(err) { //Failure
                    console.log("Error while calling BodyTemp API: ", err);
                }
            );
            session.call('com.testlab.withings_average_heartrate', ["plotly"]).then(
                function(res) { //Success
                    console.log("Received data for Heartrate")
                    handle_heartrate(res)
                },
                function(err) { //Failure
                    console.log("Error while calling HR API: ", err);
                }
            );

            // SUBSCRIPTION handler functions
            function on_haltian_location_update(args) {
                var value = args[0];
                console.log("on_haltian_location_update() event received")
                updateGoogleMaps(JSON.parse(value));
            }

            function on_withings_energy_update(args) {
                var value = args[0];
                energy_data = update_axis_data(energy_data, value)
                create_plot(energy_data, "energy")
                console.log("on_withings_energy_update() event received: " + value);
            }

            function on_withings_activity_update(args) {
                var value = args[0];
                activity_data = update_axis_data(activity_data, value)
                create_plot(activity_data, "activity")
                console.log("on_withings_activity_update() event received: " + value);
            }

            function on_withings_sleep_update(args) {
                var value = args[0];
                sleep_data = update_axis_data(sleep_data, value)
                create_plot(sleep_data, "sleep")
                console.log("on_withings_sleep_update() event received: " + value);
            }

            function on_withings_bodytemp_update(args) {
                var value = args[0];
                console.log("on_withings_bodytemp_update() event received: " + value);
                bodytemp_data = update_axis_data(bodytemp_data, value)
                create_plot(bodytemp_data, "bodytemp")
            }

            function on_withings_heartrate_update(args) {
                var value = args[0];
                heartrate_data = update_axis_data(heartrate_data, value)
                create_plot(heartrate_data, "heartrate")
                console.log("on_withings_heartrate_update() event received: " + value);
            }

            function on_withings_bloodpressure_update(args) {
                var value = args[0];
                bloodpressure_data = update_axis_data(bloodpressure_data, value)
                create_plot(bloodpressure_data, "bloodpressure")
                console.log("on_withings_bloodpressure_update() event received: " + value);
            }

            function on_ecg_update(args) {
                var value = JSON.parse(args[0]);
                ecg_line_series.append(new Date().getTime(), value[1])
            }

            // SUBSCRIBE to topics and receive events
            session.subscribe('com.testlab.haltian_location_update', on_haltian_location_update).then(
                function(sub) {
                    console.log('subscribed to topic Haltian Location Updates');
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );
            session.subscribe('com.testlab.withings_energy_update', on_withings_energy_update).then(
                function(sub) {
                    console.log('subscribed to topic Withings Energy Updates');
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );
            session.subscribe('com.testlab.withings_activity_update', on_withings_activity_update).then(
                function(sub) {
                    console.log('subscribed to topic Withings Activity Updates');
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );
            session.subscribe('com.testlab.withings_sleep_update', on_withings_sleep_update).then(
                function(sub) {
                    console.log('subscribed to topic Withings Sleep Updates');
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );
            session.subscribe('com.testlab.withings_bodytemp_update', on_withings_bodytemp_update).then(
                function(sub) {
                    console.log('subscribed to topic Withings Bodytemp Updates');
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );
            session.subscribe('com.testlab.withings_heartrate_update', on_withings_heartrate_update).then(
                function(sub) {
                    console.log('subscribed to topic Withings HR Updates');
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );
            session.subscribe('com.testlab.withings_bloodpressure_update', on_withings_bloodpressure_update).then(
                function(sub) {
                    console.log('subscribed to topic Withings BP Updates');
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );

            session.subscribe('com.testlab.ecg_update', on_ecg_update).then(
                function(sub) {
                    console.log('subscribed to topic ECG Updates');

                    canvas = document.getElementById("ecg_canvas")
                    canvas.width = $(window).width() * 0.981;
                    canvas.height = 250

                    ecg_streaming_chart = new SmoothieChart({   strokeStyle: 'rgb(144, 238, 144)',
                                                                fillStyle: 'rgb(0, 0, 0)',
                                                                millisPerPixel: 3,
                                                                maxValueScale: 0.97,
                                                                grid:{sharpLines: true},
                                                                timestampFormatter:SmoothieChart.timeFormatter,
                                                                maxValue: 3300,
                                                                minValue: 1200  })

                    ecg_streaming_chart.addTimeSeries(ecg_line_series, { strokeStyle: 'rgb(0, 255, 0)', lineWidth: 1 });
                    ecg_streaming_chart.streamTo(canvas);
                },
                function(err) {
                    console.log('failed to subscribe to topic!', err);
                }
            );
        };

        // fired when connection was lost (or could not be established)
        connection.onclose = function(reason, details) {
            console.log("Connection lost: " + reason);
            clearTimeout(haltianTimer)
            ecg_data = null
        }

        // now actually open the connection
        $(document).ready(function() {
            init()
            connection.open();
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9mV0Epe5stYJC0_DR-HHlzbMwM4WComs&callback=initGoogleMaps">
    </script>
    <div
        id="footer"><a href="#" onClick="MyWindow=window.open('https://videoneukkari.com/connect/testlab?room=TestLab&pin=1234&name=Potilas','Video Connection',width='600',height='300'); return false;" class="no-underline"><div class="footer-text">Call Doctor</div></a>
    </div>
    <!--<div class="footer"></div>-->
</body>

</html>